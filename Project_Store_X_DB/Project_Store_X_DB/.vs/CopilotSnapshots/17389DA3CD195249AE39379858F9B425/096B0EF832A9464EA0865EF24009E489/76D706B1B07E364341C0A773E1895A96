using System;
using System.Data;
using System.Data.SqlClient;

namespace Project_Store_X_DB.DAL
{
    internal class DashbroadDAL : DBConnection
    {
        // NOTE: queries assume there is a table or view "OrderManagement" that contains:
        // OrderID, CustomerID, CustomerName, OrderDate, ProductID, ProductName, Quantity, TotalAmount, CategoryID, CategoryName
        // If your schema uses Orders/OrderDetails/Products/Categories, adjust JOINs accordingly.

        public int GetNewCustomersCount(DateTime start, DateTime end)
        {
            // Count customers whose first order is in the period (approximation using OrderManagement)
            string sql = @"
                SELECT COUNT(DISTINCT CustomerID) 
                FROM OrderManagement om
                WHERE om.OrderDate BETWEEN @start AND @end
                  AND NOT EXISTS (
                      SELECT 1 FROM OrderManagement om2
                      WHERE om2.CustomerID = om.CustomerID AND om2.OrderDate < @start
                  )";
            var p = new SqlParameter[]
            {
                new SqlParameter("@start", start),
                new SqlParameter("@end", end)
            };
            var dt = ExecuteQuery(sql, p);
            if (dt.Rows.Count == 0) return 0;
            return Convert.ToInt32(dt.Rows[0][0]);
        }

        public int GetOrdersCount(DateTime start, DateTime end)
        {
            string sql = @"
                SELECT COUNT(DISTINCT OrderID) 
                FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            var dt = ExecuteQuery(sql, p);
            return (dt.Rows.Count > 0) ? Convert.ToInt32(dt.Rows[0][0]) : 0;
        }

        public int GetProductsSoldCount(DateTime start, DateTime end)
        {
            string sql = @"
                SELECT ISNULL(SUM(Quantity),0) FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            var dt = ExecuteQuery(sql, p);
            return (dt.Rows.Count > 0) ? Convert.ToInt32(dt.Rows[0][0]) : 0;
        }

        public decimal GetTotalRevenue(DateTime start, DateTime end)
        {
            string sql = @"
                SELECT ISNULL(SUM(TotalAmount),0) FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            var dt = ExecuteQuery(sql, p);
            return (dt.Rows.Count > 0) ? Convert.ToDecimal(dt.Rows[0][0]) : 0m;
        }

        public DataTable GetRevenueGrouped(DateTime start, DateTime end, string periodGroup)
        {
            // periodGroup: "day","month","quarter","year"
            string groupExpr;
            switch (periodGroup?.ToLower())
            {
                case "month":
                    groupExpr = "CONVERT(char(7), OrderDate, 126)"; // yyyy-MM
                    break;
                case "quarter":
                    groupExpr = "CONCAT(DATEPART(year,OrderDate), '-Q', DATEPART(quarter,OrderDate))";
                    break;
                case "year":
                    groupExpr = "CONVERT(char(4), DATEPART(year, OrderDate))";
                    break;
                default:
                    groupExpr = "CONVERT(char(10), OrderDate, 126)"; // yyyy-MM-dd
                    break;
            }

            string sql = $@"
                SELECT {groupExpr} AS PeriodLabel, ISNULL(SUM(TotalAmount),0) AS Revenue
                FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end
                GROUP BY {groupExpr}
                ORDER BY {groupExpr}";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            return ExecuteQuery(sql, p);
        }

        public DataTable GetRevenueByCategory(DateTime start, DateTime end)
        {
            // Assumes OrderManagement has CategoryName column; adjust if you need join
            string sql = @"
                SELECT ISNULL(CategoryName,'Uncategorized') AS CategoryName, ISNULL(SUM(TotalAmount),0) AS Revenue
                FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end
                GROUP BY ISNULL(CategoryName,'Uncategorized')
                ORDER BY Revenue DESC";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            return ExecuteQuery(sql, p);
        }

        public DataTable GetTop5BestSelling(DateTime start, DateTime end)
        {
            string sql = @"
                SELECT TOP 5 ProductName, ISNULL(SUM(Quantity),0) AS QuantitySold
                FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end
                GROUP BY ProductName
                ORDER BY QuantitySold DESC";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            return ExecuteQuery(sql, p);
        }

        public DataTable GetCustomerSpending(DateTime start, DateTime end)
        {
            string sql = @"
                SELECT CustomerID, CustomerName, ISNULL(SUM(TotalAmount),0) AS TotalSpent
                FROM OrderManagement
                WHERE OrderDate BETWEEN @start AND @end
                GROUP BY CustomerID, CustomerName
                ORDER BY TotalSpent DESC";
            var p = new SqlParameter[] { new SqlParameter("@start", start), new SqlParameter("@end", end) };
            return ExecuteQuery(sql, p);
        }
    }
}